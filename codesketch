#!/usr/bin/env bash -e

CONTROL_FILE=.codesketch

function configure {
	echo "* configuring Codesketch"
	configure_usage() {
		echo "" 
		echo "bash codesketch config: -s server name -c certificate path -k certificate key path" 1>&2; 
		echo "when provided -c option -k must be provided and vice versa."
		echo ""
		exit 1; 
	}

    local OPTIND opts server_name certificate certificate_key
    while getopts ":s:c:k:" opts; do
        case "${opts}" in
            s)
                server_name="${OPTARG}"
                ;;
            c)
                certificate="${OPTARG}"
                ;;
            k)
                certificate_key="${OPTARG}"
                ;;
            *)
                configure_usage
                ;;
        esac
    done
    shift $((OPTIND-1))

    if [[ -z "$server_name" ]] || [[ -z "$certificate" ]] || [[ -z "$certificate_key" ]]; then
    	echo "* not all of server name, certificate and certificate key has been provided using defaults"
    	server_name="codesketch.internal" 
	    certificate="/etc/nginx/certs/codesketch.crt" 
	    certificate_key="/etc/nginx/certs/codesketch.key"
    fi
    echo "* configuring SSL engine, server name:${server_name}, certificate: ${certificate}, certificate key: ${certificate_key}"
		sed -e "s/%{server_name}/${server_name}/" \
		  -e "s+%{ssl_certificate}+${certificate}+" \
		  -e "s+%{ssl_certificate_key}+${certificate_key}+" \
		  ./nginx/templates/codesketch-ssl.tpl.conf > ./nginx/conf.d/codesketch-ssl.conf
		docker network create codesketch
		docker-compose -f docker-compose-codesketch.yml pull
		docker-compose -f docker-compose-nginx.yml pull
		touch $CONTROL_FILE
		echo "* Codesketch configured"
}

function start {
	echo "* starting Codesketch in you local machine using docker compose ..."
	docker-compose -f docker-compose-codesketch.yml up -d --remove-orphans
	echo "* waiting for Codesketch to start"
	sleep 60s
	docker-compose -f docker-compose-nginx.yml up -d
	echo "Codesketch has started"
}

function stop {
	docker-compose -f docker-compose-codesketch.yml stop
	docker-compose -f docker-compose-nginx.yml stop
}

function clean {
	docker-compose -f docker-compose-codesketch.yml rm -f --all
	docker-compose -f docker-compose-nginx.yml rm -f --all
}

function logs {
	docker-compose -f docker-compose-codesketch.yml -f docker-compose-nginx.yml logs -f $1
}

function restart {
	stop
	start
}

function usage {
  echo "Usage:"
  echo "    ${0} stop <stop the platform> | start <start the platfom> | restart <redeploy the platform>"
  exit 1
}

case ${1} in
  start|stop|clean|config|logs|restart)
	case ${1} in
      start)
		if [[ ! -e ${CONTROL_FILE} ]]; then
			configure ${@:2}
		fi
		start
	  ;;
      stop)
		stop
	  ;;
	  clean)
		clean
	  ;;
	  config)
		configure ${@:2}
	  ;;
	  logs)
		logs ${@:2}
	  ;;
	  restart)
		restart ${@:2}
	  ;;
	  *)
        echo "Invalid parameter(s) or option(s)."
        usage
      ;;
    esac
    exit 0
esac