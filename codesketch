#!/usr/bin/env bash -e

function config {
	echo "Configuring Codesketch"
	docker network create codesketch
	docker-compose -f docker-compose-codesketch.yml pull
	docker-compose -f docker-compose-nginx.yml pull
	echo "... Codesketch configured"
}

function start {
	echo "Starting Codesketch in you local machine using docker compose ..."
	docker-compose -f docker-compose-codesketch.yml up -d --remove-orphans
	echo "... waiting for Codesketch to start ..."
	sleep 30s
	docker-compose -f docker-compose-nginx.yml up -d
	echo "Codesketch has started"
	TOKEN=$(docker exec jenkins-master cat /var/jenkins_home/secrets/initialAdminPassword)
	# curl 'http://localhost/jenkins/j_acegi_security_check' \ 
	#   -H 'Origin: http://localhost' -H 'Content-Type: application/x-www-form-urlencoded' \
	#   -H 'Referer: http://localhost/jenkins/login?from=%2Fjenkins%2F' \
	#   --data 'j_username=admin&j_password=$TOKEN&Jenkins-Crumb=$TOKEN&json=%7B%22j_username%22%3A+%22admin%22%2C+%22j_password%22%3A+%22$TOKEN%22%2C+%22Jenkins-Crumb%22%3A+%22d28a72490b2eb42ae2762b0fb1e4bdd8%22%7D' --compressed
	echo "Jenkins unlock token: $TOKEN"
	exit 0
}

function stop {
	docker-compose -f docker-compose-codesketch.yml stop
	docker-compose -f docker-compose-nginx.yml stop
}

function clean {
	docker-compose -f docker-compose-codesketch.yml rm -f --all
	docker-compose -f docker-compose-nginx.yml rm -f --all
}

function usage {
  echo "Usage:"
  echo "    ${0} -s <stop the platform>|-u <start the platfom>|-r <redeploy the platform>"
  exit 1
}

case ${1} in
  start|stop|clean|config)
	case ${1} in
      start)
		start
	  ;;
      stop)
		stop
	  ;;
	  clean)
		clean
	  ;;
	  config)
		config
	  ;;
	  *)
        echo "Invalid parameter(s) or option(s)."
        usage
      ;;
    esac
esac